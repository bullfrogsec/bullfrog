# Docker mod
# Accept established/related connections automatically (no need to queue)
insert rule ip filter DOCKER-USER iifname "docker0" ct state established,related counter accept
insert rule ip filter DOCKER-USER oif "docker0" ct state established,related counter accept

# Match DNS packets (port 53) and enqueue to userspace - ALL DNS traffic
insert rule ip filter DOCKER-USER iifname "docker0" udp dport 53 counter queue num 0
insert rule ip filter DOCKER-USER iifname "docker0" tcp dport 53 counter queue num 0
insert rule ip filter DOCKER-USER oif "docker0" udp sport 53 counter queue num 0
insert rule ip filter DOCKER-USER oif "docker0" tcp sport 53 counter queue num 0

# Queue new connections (non-DNS) for Go agent decision
insert rule ip filter DOCKER-USER iifname "docker0" ct state new counter queue num 0

# Drop everything else (shouldn't reach here if Go agent is working)
insert rule ip filter DOCKER-USER iifname "docker0" counter drop
# End of Docker mod


table inet filter {
    chain input {
        type filter hook input priority 0; policy accept;

        # Match DNS responses FIRST (before conntrack check)
        # Otherwise established DNS responses would bypass the queue
        udp sport 53 counter queue num 0
        tcp sport 53 counter queue num 0

        # Accept established/related connections automatically
        ct state established,related counter accept

        # Queue new connections for Go agent decision
        ct state new counter queue num 0
    }

    chain output {
        type filter hook output priority 0; policy accept;

        # Match DNS requests FIRST (before conntrack check)
        # Otherwise established DNS queries would bypass the queue
        udp dport 53 counter queue num 0
        tcp dport 53 counter queue num 0

        # Accept established/related connections automatically
        ct state established,related counter accept

        # Queue new connections for Go agent decision
        ct state new counter queue num 0
    }
}
 